# https://www.playframework.com/documentation/latest/Configuration

# Broker settings
broker {

	name = "broker-akka"

	server-config {
		dsId = "broker-akka-FEuG-dsvoy3Mfh-DY4ZLqxWdcjA9mky2MyCd0DmqTMw"
		publicKey = "BG4OYopcM2q09amKRKsc8N99ns5dybnBYG4Fi8bQVf6fKjyT_KRlPMJCs-3zvnSbBCXzS5fZfi88JuiLYwJY0gc"
		tempKey = "BARngwlfjwD7goZHCh_4iWsP0e3JszsvOtovn1UyPnqZLlSOyoUH1v_Lop0oUFClpVhlzsWAAqur6S8apZaBe4I"
		wsUrl = "/ws"
		httpUri = "/http"
		salt = 1234
		version = "1.1.2"
		updateInterval = 200
		# This line enables ability to use msgpack protocol in DSA messages btw DSLinks and the broker.
		# The commutication switches to MSGPACK when both sides (broker and a DSLINK) support it. if only
		# one side supports - "json" protocol will be used.
		# If you whould like to force using JSON protocol, just delete the "msgpack" string from
		# bellow string array
		format = ["json", "msgpack"]
	}

	salt = 1234

	subscriptions {
	    reconnectionTimeout = 30
	    queue.capacity = 30
	}

	# web socket configuration
	ws {
	  buffer = 128
	  overflow.strategy = dropNew
	}

	# maximum number of child rows in a single LIST response
	children.per.response = 100

	# response delivery engine
	responder {
		# simple, pooled, pubsub, dpubsub
		group.call.engine = simple

		list.pool.size = 5
		subscribe.pool.size = 5
	}

	# applicable only to clustered deployment
	downstream.shard.count = 100

	query.timeout = 5s

	metrics {
		# jdbc, influxdb or none
		collector = none
		retention {
			default = null
			# uncomment individual retention policies
			# ws_session = "week"
		}

		# uncomment to include geolocation resolution
		# geoip.db = "path-to-geolite.mmdb"
	}

	# true - show raw JSON data; false - show data objects
	logging.show.ws.payload = true
}

# Play Framework settings
play {
	http.secret.key = "y:UduF]/^Rr_IwNoql]>PDPatShuEa07WZpzJm>_?Y4<7BP_Gmpt4?35CACz28D0"
	server.websocket.frame.maxLength = 20000000
	akka.actor-system = "DSASystem"

	# disabling all filters until the security config is finalized
	filters.enabled=[]

	filters.headers {
	  contentSecurityPolicy = "default-src 'self';"
	  contentSecurityPolicy = ${play.filters.headers.contentSecurityPolicy}" img-src 'self' *.fbcdn.net *.twimg.com *.googleusercontent.com *.xingassets.com vk.com *.yimg.com secure.gravatar.com;"
	  contentSecurityPolicy = ${play.filters.headers.contentSecurityPolicy}" style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com maxcdn.bootstrapcdn.com cdn.jsdelivr.net fonts.googleapis.com;"
	  contentSecurityPolicy = ${play.filters.headers.contentSecurityPolicy}" font-src 'self' fonts.gstatic.com fonts.googleapis.com cdnjs.cloudflare.com;"
	  contentSecurityPolicy = ${play.filters.headers.contentSecurityPolicy}" script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com;"
	  contentSecurityPolicy = ${play.filters.headers.contentSecurityPolicy}" connect-src 'self' twitter.com *.xing.com;"
	}

	modules.enabled  += "models.MainModule"

	# Setting up https settings and values
	# For more options check https://www.playframework.com/documentation/2.6.x/SettingsAkkaHttp
	# The manual for creating ROOT sertificate is: https://lightbend.github.io/ssl-config/WSQuickStart.html
	# The property of the generated selfsign key is: CN=Admin, OU=IT, O=Acuitybrands, L=Athlas, ST=CA, C=US
	# Extra properties are: Alias: scala-broker, Password: acuitybrands
	server.https {
		port = 9443

		keyStore.path = "conf/store.jks"
		keyStore.type = "JKS"
		keyStore.password = "acuitybrands"
	}
}

kamon {

  util.filters {

      "akka.tracked-dispatcher" {
        includes = [ "**" ]
      }

      "akka.tracked-router" {
        includes = [ "**" ]
      }

      "ws-actors" {
         includes = [ "DSASystem/user/*/wsActor" ]
      }

      "dslink-downstream-actors" {
         includes = [ "DSASystem/user/downstream/**" ]
      }

      "dslink-upstream-actors" {
         includes = [ "DSASystem/user/upstream/**" ]
      }

      "akka.traced-actor" {
        includes = [ "**" ]
        excludes = [ "DSASystem/system/**"]
      }

  }

  akka.actor-groups = [ "ws-actors", "dslink-downstream-actors", "dslink-upstream-actors" ]
  trace.join-remote-parents-with-same-span-id = true

}

akka.remote.netty.tcp.port=2551


# Akka settings
akka {

    http.parsing {
        uri-parsing-mode = relaxed
    }

	loglevel = "INFO"
	loggers = ["akka.event.slf4j.Slf4jLogger"]
	logging-filter = "akka.event.slf4j.Slf4jLoggingFilter"
	logger-startup-timeout = 30s

	persistence {
		journal.plugin = "akka.persistence.journal.inmem"
		snapshot-store.plugin = "akka.persistence.snapshot-store.local"
	}

}

akka.actor.mailbox.requirements {
	"akka.dispatch.BoundedDequeBasedMessageQueueSemantics" = bounded-mailbox
	"akka.dispatch.BoundedMessageQueueSemantics" = bounded-mailbox
}

bounded-mailbox {
	mailbox-type = "akka.dispatch.NonBlockingBoundedMailbox"
	mailbox-capacity = 1000
}


akka.actor {

  serializers {
    kryo = "com.romix.akka.serialization.kryo.KryoSerializer"
  }

  kryo {
    idstrategy = "explicit"
    use-unsafe = true
    post-serialization-transformations = "lz4"
    implicit-registration-logging = false
    mappings = {
      # java basic types
      "java.math.BigDecimal" = 10001
      "java.math.MathContext" = 10002
      "java.math.RoundingMode" = 10003

      # scala basic types
      "scala.collection.immutable.$colon$colon" = 11001
      "scala.None$" = 11002
      "scala.Some" = 11003
      "scala.collection.immutable.Map$EmptyMap$" = 11004
      "scala.collection.immutable.Nil$" = 11005
      "scala.math.BigDecimal" = 11006
      "scala.collection.immutable.Map$Map1" = 11007
      "scala.collection.immutable.Map$Map2" = 11008
      "scala.collection.immutable.Map$Map3" = 11009
      "scala.collection.immutable.HashMap$HashTrieMap" = 11010
      "scala.collection.mutable.ArrayBuffer" = 11011
      "scala.collection.immutable.TreeMap" = 11012
      "scala.collection.immutable.Map$Map4" = 11013
      "scala.collection.immutable.Set$Set1" = 11014
      "scala.collection.immutable.HashSet$HashSet1" = 11015

      # akka basic types
      "akka.actor.Identify$" = 12001
      "akka.actor.RepointableActorRef" = 12002
      "akka.actor.LocalActorRef" = 12003
      "akka.actor.Address" = 12004
      "akka.actor.PoisonPill$" = 12005

      # broker types
      "models.akka.ConnectionInfo" = 13001
      "models.akka.cluster.EntityEnvelope" = 13002
      "models.akka.DSLinkMode$" = 13003
      "models.akka.cluster.PeerMessage" = 13004
      "models.RequestEnvelope" = 13005
      "models.ResponseEnvelope" = 13006

      # dsa messages
      "models.rpc.EmptyMessage" = 14001
      "models.rpc.AllowedMessage" = 14002
      "models.rpc.PingMessage" = 14003
      "models.rpc.PongMessage" = 14004
      "models.rpc.ResponseMessage" = 14005
      "models.rpc.RequestMessage" = 14006
      "models.rpc.ListRequest" = 14007
      "models.rpc.SetRequest" = 14008
      "models.rpc.RemoveRequest" = 14009
      "models.rpc.InvokeRequest" = 14010
      "models.rpc.SubscribeRequest" = 14011
      "models.rpc.UnsubscribeRequest" = 14012
      "models.rpc.CloseRequest" = 14013
      "models.rpc.DSAMethod$" = 14014
      "models.rpc.DSAResponse" = 14015
      "models.rpc.StreamState$" = 14016
      "models.rpc.DSAValue$NumericValue" = 14017
      "models.rpc.DSAValue$StringValue" = 14018
      "models.rpc.DSAValue$BooleanValue" = 14019
      "models.rpc.DSAValue$BinaryValue" = 14020
      "models.rpc.DSAValue$MapValue" = 14021
      "models.rpc.DSAValue$ArrayValue" = 14022
      "models.rpc.SubscriptionPath" = 14023
      "models.rpc.DSAError" = 14024

      # messages
      "models.akka.Messages$GetOrCreateDSLink" = 15001
      "models.akka.Messages$RemoveDSLink" = 15002
      "models.akka.Messages$GetDSLinkNames$" = 15003
      "models.akka.Messages$RegisterDSLink" = 15004
      "models.akka.Messages$LinkState" = 15005
      "models.akka.Messages$DSLinkStateChanged" = 15006
      "models.akka.Messages$UnregisterDSLink" = 15007
      "models.akka.Messages$ConnectEndpoint" = 15008
      "models.akka.Messages$DisconnectEndpoint" = 15009
      "models.akka.Messages$GetLinkInfo$" = 15010
      "models.akka.Messages$LinkInfo" = 15011
      "models.akka.Messages$GetDSLinkStats$" = 15012
      "models.akka.Messages$DSLinkNodeStats" = 15013
      "models.akka.Messages$DSLinkStats" = 15014
      "models.akka.Messages$FindDSLinks" = 15015
      "models.akka.Messages$RemoveDisconnectedDSLinks$" = 15016
      "models.akka.Messages$DisconnectEndpoint$" = 15017
    }
  }

  serialization-bindings {
    # akka types
    "akka.actor.PoisonPill$" = kryo

    # broker types
    "models.akka.cluster.EntityEnvelope" = kryo
    "models.RequestEnvelope" = kryo
    "models.ResponseEnvelope" = kryo

    # dsa messages
    "models.rpc.DSAMessage" = kryo
    "models.rpc.EmptyMessage" = kryo
    "models.rpc.AllowedMessage" = kryo
    "models.rpc.PingMessage" = kryo
    "models.rpc.PongMessage" = kryo
    "models.rpc.ResponseMessage" = kryo
    "models.rpc.RequestMessage" = kryo
  }
}

# uncomment to use InfluxDB database for metric collection
#influxdb.host = "localhost"
#influxdb.port = 8086
#influxdb.database = "dsabroker"

# uncomment to use JDBC database for metric collection
#db.default.driver=org.h2.Driver
#db.default.url="jdbc:h2:mem:play"